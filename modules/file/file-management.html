<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <!-- import CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <meta name="viewport"
        content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <style>
        .el-select .el-input {
          width: 150px;
        }
        .input-with-select .el-input-group__prepend {
          background-color: #fff;
        }
        .el-main{
          min-height: calc(100vh - 72px);
        }
      </style>
  <div id="app">
      <el-input placeholder="Please input" v-model="token"  v-if="!valid">
          <template slot="append"  >  <el-button slot="append" icon="el-icon-search" @click="getFiles">验证</el-button></template>
        </el-input>
      <el-container style="height: 500px; border: 1px solid #eee" v-if="valid"> 
          <el-container>
            <el-header style="text-align: right; font-size: 12px">

                <el-input placeholder="Please input" v-model="keyword" class="input-with-select" v-on:keyup.enter="getFiles">
                    <el-select v-model="select" slot="prepend" placeholder="Select">
                      <el-option label="按时间降" value="UNIX_TIMESTAMP(createTime)-desc"></el-option>
                      <el-option label="按时间升 " value="UNIX_TIMESTAMP(createTime)-asc"></el-option>
                      <el-option label="文件大小升" value="fileSize-asc"></el-option>
                      <el-option label="文件大小降"value="fileSize-desc"></el-option>
 
                    </el-select>
                    <el-button slot="append" icon="el-icon-search" @click="getFiles"></el-button>
                  </el-input>


              <!-- <el-dropdown>
                <i class="el-icon-setting" style="margin-right: 15px"></i>
                <el-dropdown-menu slot="dropdown">
                  <el-dropdown-item>View</el-dropdown-item>
                  <el-dropdown-item>Add</el-dropdown-item>
                  <el-dropdown-item>Delete</el-dropdown-item>
                </el-dropdown-menu>
              </el-dropdown>
              <span>Tom</span> -->
            </el-header>
            
            <el-main>
              <el-table :data="tableData">
                <el-table-column prop="createTime" label="createTime" width="140">
                </el-table-column>
                <el-table-column prop="filename" label="filename" width="120">
                </el-table-column>
                <el-table-column prop="fullpath" label="fullpath">
                </el-table-column>
                <el-table-column prop="fileSize" label="fileSize">
                  </el-table-column>
                  <el-table-column prop="handle" label="handle"> 
                      <template slot-scope="scope">
                    <el-button type="primary" icon=" el-icon-view" circle @click="handleEdit(scope.$index, scope.row)"></el-button>
                   
                    <el-button type="danger" icon="el-icon-delete" circle @click="handleDelete(scope.$index, scope.row)"></el-button>
                    </template>
                    </el-table-column>
              </el-table>
            </el-main>
          </el-container>
        </el-container>
         
  </div>
</body>
  <!-- import Vue before Element -->
  <script src="https://unpkg.com/vue/dist/vue.js"></script>
  <!-- import JavaScript -->
  <script src="https://unpkg.com/element-ui/lib/index.js"></script>
  <script>

//   const axios = new Axios();
  const baseURL = location.host != "localhost:3000" ? 'http://www.popochiu.com/' : 'http://localhost:3000/' 
  
    new Vue({
      el: '#app',
      data: function() {
        return { 
          instance: null,
          keyword: '',
          valid: false,
          token: 0,
          select: 'UNIX_TIMESTAMP(createTime)-desc',
          visible: false,
          tableData:  []
        }
      },
      methods: {
        getFiles(){  

          if(!this.token){
            return
          }
          const queryCondi = {
            "orders": [],
            "filters": []
          } 
          queryCondi.orders.push(
            {"orderby": this.select.split('-').pop(),
            "key":this.select.split('-')[0],
            "priority":2}
          ) 
          queryCondi.filters.push(
            {"key":"filename",
            "value":this.keyword}
          )
            this.instance.post('file/getAllFiles', queryCondi)
                .then( response => {
                    // handle success

                    if(this.token){
                      localStorage.setItem('token', this.token) 
                    }
                    console.log(response);
                    this.valid = true
                    this.tableData = response.data
                })
                .catch(function (error) {
                    // handle error
                    console.log(error);
                })
                .finally(function () {
                    // always executed
                });
        },
        handleEdit(index, row) {
          window.open(row.fullpath)
        console.log(index, row);
        },
        handleDelete(index, row) {
          console.log(index, row);
          if(!row.id)return
          this.instance.post('file/removeFileById', {
            id: row.id
          })
                .then( response => { 
                })
                .catch(function (error) {
                    // handle error
                    console.log(error);
                })
                .finally(function () {
                    // always executed
                });
        }, 
      },
      mounted() {
        let token = localStorage.getItem('token') 
        this.token = token
        this.instance = axios.create({
          baseURL: baseURL,
          timeout: 20000,
          headers: {'token': token}
        });
        
          this.getFiles()
      },
    })
  </script>
</html>